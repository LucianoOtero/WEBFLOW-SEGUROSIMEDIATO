# CORREÇÃO CORS - REMOVER HEADERS DUPLICADOS
# Data: 12/11/2025
# Motivo: Headers CORS estão sendo enviados tanto pelo Nginx quanto pelo PHP
# Solução: Remover headers do Nginx e deixar PHP controlar via setCorsHeaders()
# Arquivo: /etc/nginx/sites-available/dev.bssegurosimediato.com.br

# ============================================================================
# INSTRUÇÕES DE APLICAÇÃO
# ============================================================================
#
# 1. Fazer backup do arquivo original:
#    cp /etc/nginx/sites-available/dev.bssegurosimediato.com.br \
#       /etc/nginx/sites-available/dev.bssegurosimediato.com.br.backup_ANTES_CORRECAO_CORS_$(date +%Y%m%d_%H%M%S)
#
# 2. Editar arquivo: /etc/nginx/sites-available/dev.bssegurosimediato.com.br
#
# 3. Localizar bloco location ~ \.php$ (após include fastcgi_params;)
#
# 4. Comentar ou remover as seguintes linhas (linhas 76-79):
#
#    # REMOVER ESTAS LINHAS:
#    add_header 'Access-Control-Allow-Origin' '$http_origin' always;
#    add_header 'Access-Control-Allow-Methods' 'POST, GET, OPTIONS' always;
#    add_header 'Access-Control-Allow-Headers' 'Content-Type, X-Webflow-Signature, X-Webflow-Timestamp' always;
#    add_header 'Access-Control-Allow-Credentials' 'true' always;
#
#    TORNAR-SE-Á:
#    # add_header 'Access-Control-Allow-Origin' '$http_origin' always;
#    # add_header 'Access-Control-Allow-Methods' 'POST, GET, OPTIONS' always;
#    # add_header 'Access-Control-Allow-Headers' 'Content-Type, X-Webflow-Signature, X-Webflow-Timestamp' always;
#    # add_header 'Access-Control-Allow-Credentials' 'true' always;
#
# 5. Testar configuração:
#    nginx -t
#
# 6. Se teste passar, recarregar Nginx:
#    systemctl reload nginx
#
# 7. Verificar se erro CORS foi resolvido testando placa-validate.php no browser
#
# ============================================================================
# CONTEXTO DA MUDANÇA
# ============================================================================
#
# ANTES (com duplicação):
#   - Nginx envia: Access-Control-Allow-Origin: $http_origin
#   - PHP envia: Access-Control-Allow-Origin: https://segurosimediato-dev.webflow.io
#   - Resultado: Header duplicado → Browser bloqueia
#
# DEPOIS (sem duplicação):
#   - Nginx: Não envia headers CORS
#   - PHP envia: Access-Control-Allow-Origin: https://segurosimediato-dev.webflow.io
#   - Resultado: Header único → Browser permite
#
# ============================================================================
# NOTAS IMPORTANTES
# ============================================================================
#
# - PHP já controla headers CORS via setCorsHeaders() em config.php
# - PHP valida origem antes de enviar header (mais seguro)
# - Validação de origem feita via isCorsOriginAllowed() em config.php
# - Esta correção resolve duplicação mantendo segurança
#
# ============================================================================
# COMANDOS RÁPIDOS (copiar e colar)
# ============================================================================
#
# # Backup
# cp /etc/nginx/sites-available/dev.bssegurosimediato.com.br \
#    /etc/nginx/sites-available/dev.bssegurosimediato.com.br.backup_ANTES_CORRECAO_CORS_$(date +%Y%m%d_%H%M%S)
#
# # Comentar linhas 76-79
# sed -i '76s/^/# /' /etc/nginx/sites-available/dev.bssegurosimediato.com.br
# sed -i '77s/^/# /' /etc/nginx/sites-available/dev.bssegurosimediato.com.br
# sed -i '78s/^/# /' /etc/nginx/sites-available/dev.bssegurosimediato.com.br
# sed -i '79s/^/# /' /etc/nginx/sites-available/dev.bssegurosimediato.com.br
#
# # Testar
# nginx -t
#
# # Recarregar (se teste passar)
# systemctl reload nginx

