<?php
/**
 * PROJETO: ENDPOINT DE NOTIFICA√á√ÉO EMAIL ADMINISTRADORES
 * IN√çCIO: 03/11/2025 19:00
 * 
 * VERS√ÉO: 1.1 - Suporte a notifica√ß√µes de erro
 * 
 * Endpoint dedicado APENAS para receber dados do JavaScript
 * e enviar notifica√ß√µes por email aos administradores via Amazon SES.
 * 
 * Este endpoint √© chamado pelo FooterCodeSiteDefinitivoCompleto.js
 * ap√≥s sucesso nas chamadas do modal para add_flyingdonkeys_v2.php
 * 
 * ‚ö†Ô∏è IMPORTANTE: Este endpoint N√ÉO processa dados de CRM,
 * apenas envia emails de notifica√ß√£o.
 */

header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');

// Tratar OPTIONS (preflight CORS)
$requestMethod = $_SERVER['REQUEST_METHOD'] ?? '';
if ($requestMethod === 'OPTIONS') {
    http_response_code(200);
    exit;
}

// Apenas POST permitido
if ($requestMethod !== 'POST') {
    http_response_code(405);
    echo json_encode([
        'success' => false,
        'error' => 'Method not allowed. Use POST.'
    ]);
    exit;
}

// Carregar sistema de logging profissional
require_once __DIR__ . '/ProfessionalLogger.php';

// Carregar fun√ß√£o de notifica√ß√£o
require_once __DIR__ . '/send_admin_notification_ses.php';

// Inicializar logger
$logger = new ProfessionalLogger();

try {
    // Ler dados do POST
    $rawInput = file_get_contents('php://input');
    $data = json_decode($rawInput, true);
    
    if (json_last_error() !== JSON_ERROR_NONE) {
        throw new Exception('JSON inv√°lido: ' . json_last_error_msg());
    }
    
    // Validar dados m√≠nimos
    $ddd = $data['ddd'] ?? '';
    $celular = $data['celular'] ?? '';
    
    // Permitir valores padr√£o do sistema de logging (00 e 000000000)
    $isLoggingSystem = ($ddd === '00' && $celular === '000000000' && isset($data['erro']));
    
    if (!$isLoggingSystem && (empty($ddd) || empty($celular))) {
        throw new Exception('DDD e CELULAR s√£o obrigat√≥rios');
    }
    
    // Preparar dados para fun√ß√£o de envio
    $emailData = [
        'ddd' => $ddd,
        'celular' => $celular,
        'cpf' => $data['cpf'] ?? 'N√£o informado',
        'nome' => $data['nome'] ?? 'N√£o informado',
        'email' => $data['email'] ?? 'N√£o informado',
        'cep' => $data['cep'] ?? 'N√£o informado',
        'placa' => $data['placa'] ?? 'N√£o informado',
        'gclid' => $data['gclid'] ?? 'N√£o informado',
        'momento' => $data['momento'] ?? 'unknown',
        'momento_descricao' => $data['momento_descricao'] ?? 'Notifica√ß√£o',
        'momento_emoji' => $data['momento_emoji'] ?? 'üìß',
        // NOVO: Informa√ß√µes de erro (se presente)
        'erro' => $data['erro'] ?? null
    ];
    
    // Enviar email
    $result = enviarNotificacaoAdministradores($emailData);
    
    // Log de resultado usando sistema profissional
    $logLevel = $result['success'] ? 'INFO' : 'WARN';
    $logMessage = sprintf(
        "[EMAIL-ENDPOINT] Momento: %s | DDD: %s | Celular: %s*** | Sucesso: %s | Erro: %s",
        $emailData['momento'],
        $ddd,
        substr($celular, 0, 3),
        $result['success'] ? 'SIM' : 'N√ÉO',
        ($emailData['erro'] !== null) ? 'SIM' : 'N√ÉO'
    );
    $logger->log($logLevel, $logMessage, [
        'momento' => $emailData['momento'],
        'ddd' => $ddd,
        'celular_masked' => substr($celular, 0, 3) . '***',
        'success' => $result['success'],
        'has_error' => ($emailData['erro'] !== null),
        'total_sent' => $result['total_sent'] ?? 0,
        'total_failed' => $result['total_failed'] ?? 0
    ], 'EMAIL');
    
    // Retornar resultado
    // HTTP 200 mesmo quando success=false, pois a requisi√ß√£o foi processada corretamente
    // (diferente de erro de valida√ß√£o ou processamento)
    http_response_code(200);
    echo json_encode($result);
    
} catch (Throwable $e) {
    // Log de erro usando sistema profissional
    $errorMessage = $e->getMessage();
    $errorFile = $e->getFile();
    $errorLine = $e->getLine();
    $errorClass = get_class($e);
    
    // Log detalhado
    if (isset($logger)) {
        try {
            $logger->error("[EMAIL-ENDPOINT] Erro: " . $errorMessage, [
                'exception' => $errorClass,
                'file' => $errorFile,
                'line' => $errorLine,
                'trace' => $e->getTraceAsString()
            ], 'EMAIL', $e);
        } catch (Throwable $logError) {
            // Se logging falhar, usar error_log como fallback
            error_log("[EMAIL-ENDPOINT] Erro ao logar: " . $logError->getMessage());
            error_log("[EMAIL-ENDPOINT] Erro original: " . $errorMessage . " em " . $errorFile . ":" . $errorLine);
        }
    } else {
        error_log("[EMAIL-ENDPOINT] Erro: " . $errorMessage . " em " . $errorFile . ":" . $errorLine);
    }
    
    // Garantir que headers n√£o foram enviados
    if (!headers_sent()) {
        http_response_code(500);
        header('Content-Type: application/json; charset=utf-8');
    }
    
    // Retornar erro de forma segura
    $errorResponse = [
        'success' => false,
        'error' => $errorMessage,
        'error_type' => $errorClass
    ];
    
    // Em produ√ß√£o, n√£o expor detalhes do arquivo/linha
    if (defined('APP_ENVIRONMENT') && APP_ENVIRONMENT === 'production') {
        unset($errorResponse['error_type']);
    }
    
    echo json_encode($errorResponse);
}

